name: Reusable Lock Workflow

on:
    workflow_call:
        inputs:
            key:
                description: "Key to lock (e.g., dev, staging, prod)"
                required: true
                type: string
            key_owner:
                description: "Key owner identifier (e.g., PR number, SHA, run ID)"
                required: true
                type: string

permissions:
    contents: write

jobs:
    lock:
        runs-on: ubuntu-latest
        steps:
            - uses: github/lock@v3.0.1
              id: check-lock
              with:
                  mode: "check"
                  environment: ${{ inputs.key }}

            - name: Check if locked by same owner
              id: check-owner
              shell: bash
              run: |
                  # Sanitize inputs by removing any trailing quotes or special chars
                  KEY="${{ inputs.key }}"
                  KEY_OWNER="${{ inputs.key_owner }}"
                  LOCK_REASON="${{ steps.check-lock.outputs.reason }}"
                  LOCKED="${{ steps.check-lock.outputs.locked }}"

                  echo "Key: $KEY"
                  echo "Key owner: $KEY_OWNER"
                  echo "Lock reason: $LOCK_REASON"
                  echo "Locked: $LOCKED"

                  if [ "$LOCKED" = "true" ]; then
                    echo "Lock exists, checking owner..."
                    LOCK_OWNER=$(echo "$LOCK_REASON" | grep -o 'owner:[^,]*' | cut -d: -f2 || true)

                    echo "Lock owner: $LOCK_OWNER"
                    echo "Current owner: $KEY_OWNER"

                    if [ "$LOCK_OWNER" = "$KEY_OWNER" ]; then
                      echo "✓ Lock is already held by this owner"
                      echo "should_proceed=true" >> $GITHUB_OUTPUT
                    elif [ -z "$LOCK_OWNER" ]; then
                      echo "✓ Lock is available (no owner)"
                      echo "should_proceed=true" >> $GITHUB_OUTPUT
                    else
                      echo "✗ Lock is held by $LOCK_OWNER"
                      echo "Current owner: $KEY_OWNER"
                      echo "should_proceed=false" >> $GITHUB_OUTPUT
                      echo "::error::Key '$KEY' is locked by $LOCK_OWNER"
                      exit 1
                    fi
                  else
                    echo "✓ Key is not locked"
                    echo "should_proceed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Prepare lock reason
              id: lock-reason
              run: |
                  # Simple reason with owner information
                  REASON="owner:${{ inputs.key_owner }}"

                  echo "Lock reason: $REASON"
                  echo "reason=$REASON" >> $GITHUB_OUTPUT
              if: steps.check-owner.outputs.should_proceed == 'true'

            - uses: github/lock@v3.0.1
              id: lock
              with:
                  mode: "lock"
                  environment: ${{ inputs.key }}
                  reason: ${{ steps.lock-reason.outputs.reason }}
              if: steps.check-owner.outputs.should_proceed == 'true'

            - name: Final lock status
              if: always()
              run: |
                  echo "=== Lock Result ==="
                  echo "Key: ${{ inputs.key }}"
                  echo "Owner: ${{ inputs.key_owner }}"
                  echo "Status: ${{ steps.lock.outcome }}"
