name: Reusable Lock Workflow

on:
    workflow_call:
        inputs:
            key:
                description: "Key to lock (e.g., dev, staging, prod)"
                required: true
                type: string
            key_owner:
                description: "Key owner identifier (e.g., PR number, SHA, run ID)"
                required: true
                type: string

permissions:
    contents: write

jobs:
    lock:
        runs-on: ubuntu-latest
        steps:
            - uses: github/lock@v3.0.1
              id: check-lock
              with:
                  mode: "check"
                  environment: ${{ inputs.key }}

            - name: Check if locked by same owner
              id: check-owner
              run: |
                  echo "Key: ${{ inputs.key }}"
                  echo "Key owner: ${{ inputs.key_owner }}"
                  echo "Lock reason: ${{ steps.check-lock.outputs.reason }}"

                  if [ "${{ steps.check-lock.outputs.locked }}" = "true" ]; then
                    # Extract owner from lock reason using simple regex
                    LOCK_REASON="${{ steps.check-lock.outputs.reason }}"
                    LOCK_OWNER=$(echo "$LOCK_REASON" | grep -o 'owner:[^,]*' | cut -d: -f2)
                    CURRENT_OWNER="${{ inputs.key_owner }}"

                    echo "Lock owner: $LOCK_OWNER"
                    echo "Current owner: $CURRENT_OWNER"

                    # Allow if same owner or no owner in lock
                    if [ "$LOCK_OWNER" = "$CURRENT_OWNER" ] || [ -z "$LOCK_OWNER" ]; then
                      echo "✓ Lock is available (same owner or no owner lock)"
                      echo "should_proceed=true" >> $GITHUB_OUTPUT
                    else
                      echo "✗ Lock is held by different owner ($LOCK_OWNER)"
                      echo "should_proceed=false" >> $GITHUB_OUTPUT
                      echo "::error::Key '${{ inputs.key }}' is locked by owner $LOCK_OWNER"
                      exit 1
                    fi
                  else
                    echo "✓ Key is not locked"
                    echo "should_proceed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Prepare lock reason
              id: lock-reason
              run: |
                  # Simple reason with owner information
                  REASON="owner:${{ inputs.key_owner }}"

                  echo "Lock reason: $REASON"
                  echo "reason=$REASON" >> $GITHUB_OUTPUT
              if: steps.check-owner.outputs.should_proceed == 'true'

            - uses: github/lock@v3.0.1
              id: lock
              with:
                  mode: "lock"
                  environment: ${{ inputs.key }}
                  reason: ${{ steps.lock-reason.outputs.reason }}
              if: steps.check-owner.outputs.should_proceed == 'true'

            - name: Final lock status
              if: always()
              run: |
                  echo "=== Lock Result ==="
                  echo "Key: ${{ inputs.key }}"
                  echo "Owner: ${{ inputs.key_owner }}"
                  echo "Status: ${{ steps.lock.outcome }}"
