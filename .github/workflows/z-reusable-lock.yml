name: Reusable Lock Workflow

on:
    workflow_call:
        inputs:
            key:
                description: "Key to lock (e.g., dev, staging, prod)"
                required: true
                type: string

permissions:
    contents: write

jobs:
    lock:
        runs-on: ubuntu-latest
        steps:
            - uses: github/lock@v3.0.1
              id: check-lock
              with:
                  mode: "check"
                  environment: ${{ inputs.key }}

            - name: Check if locked by current PR
              id: check-pr
              run: |
                  echo "Current PR: ${{ github.event.number }}"
                  echo "Key: ${{ inputs.key }}"
                  echo "Lock reason: ${{ steps.check-lock.outputs.reason }}"

                  if [ "${{ steps.check-lock.outputs.locked }}" = "true" ]; then
                    # Extract PR number from lock reason using simple regex
                    LOCK_REASON="${{ steps.check-lock.outputs.reason }}"
                    LOCK_PR=$(echo "$LOCK_REASON" | grep -o 'pr:[^,]*' | cut -d: -f2)
                    CURRENT_PR="${{ github.event.number }}"

                    echo "Lock PR: $LOCK_PR"
                    echo "Current PR: $CURRENT_PR"

                    # Allow if same PR or no lock
                    if [ "$LOCK_PR" = "$CURRENT_PR" ] || [ -z "$LOCK_PR" ]; then
                      echo "✓ Lock is available (same PR or no PR lock)"
                      echo "should_proceed=true" >> $GITHUB_OUTPUT
                    else
                      echo "✗ Lock is held by different PR ($LOCK_PR)"
                      echo "should_proceed=false" >> $GITHUB_OUTPUT
                      echo "::error::Key '${{ inputs.key }}' is locked by PR $LOCK_PR"
                      exit 1
                    fi
                  else
                    echo "✓ Key is not locked"
                    echo "should_proceed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Prepare lock reason
              id: lock-reason
              run: |
                  # Simple reason with PR information
                  CURRENT_PR="${{ github.event.number }}"
                  REASON="pr:${CURRENT_PR}"

                  echo "Lock reason: $REASON"
                  echo "reason=$REASON" >> $GITHUB_OUTPUT
              if: steps.check-pr.outputs.should_proceed == 'true'

            - uses: github/lock@v3.0.1
              id: lock
              with:
                  mode: "lock"
                  environment: ${{ inputs.key }}
                  reason: ${{ steps.lock-reason.outputs.reason }}
              if: steps.check-pr.outputs.should_proceed == 'true'

            - name: Final lock status
              if: always()
              run: |
                  echo "=== Lock Result ==="
                  echo "Key: ${{ inputs.key }}"
                  echo "Status: ${{ steps.lock.outcome }}"
                  echo "PR: ${{ github.event.number }}"
