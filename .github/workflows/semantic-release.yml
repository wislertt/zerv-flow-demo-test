name: semantic-release

on:
    workflow_call:
        inputs:
            allowed_workflow_dispatch_branches:
                description: "Comma-separated list of branches allowed for workflow dispatch"
                required: false
                default: '["main"]'
                type: string
        outputs:
            version:
                description: "The determined version"
                value: ${{ jobs.semantic-release.outputs.new_release_version }}
            published:
                description: "Whether a new release was published"
                value: ${{ jobs.semantic-release.outputs.new_release_published }}
            is_valid_semantic_release:
                description: "Whether semantic-release job was executed successfully (regardless of whether it published a release)"
                value: ${{ jobs.semantic-release.result == 'success' }}

permissions:
    contents: write
    issues: write
    pull-requests: write

jobs:
    # TODO: debug this
    # Not a tag, running on branch: refs/heads/release/15/dev
    # it should not valid in this case.
    validate-tag-for-workflow-dispatch:
        name: validate-tag-for-workflow-dispatch
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch'
        outputs:
            is_valid: ${{ steps.check-tag.outputs.is_valid }}
            tag_version: ${{ steps.check-tag.outputs.tag_version }}
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 0

            - name: Check tag format or branch permission
              id: check-tag
              run: |
                  # Get the current ref
                  REF="${{ github.ref }}"

                  # Get allowed branches - parse JSON array
                  ALLOWED_BRANCHES=$(echo "${{ inputs.allowed_workflow_dispatch_branches }}" | jq -r '.[]')

                  # Check if ref is a tag
                  if [[ $REF == refs/tags/* ]]; then
                    # Extract tag name from ref
                    TAG_NAME=${REF#refs/tags/}
                    echo "Checking tag: $TAG_NAME"

                    # Validate tag format: vX.X.X where X is numeric
                    if [[ $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                      echo "✓ Tag format is valid"
                      echo "is_valid=true" >> $GITHUB_OUTPUT
                      # Remove 'v' prefix for version
                      VERSION=${TAG_NAME#v}
                      echo "tag_version=$VERSION" >> $GITHUB_OUTPUT
                    else
                      echo "✗ Invalid tag format. Expected format: vX.X.X (e.g., v1.0.0)"
                      echo "Found: $TAG_NAME"
                      echo "is_valid=false" >> $GITHUB_OUTPUT
                      echo "tag_version=" >> $GITHUB_OUTPUT
                    fi
                  else
                    # It's a branch ref
                    BRANCH_NAME=${REF#refs/heads/}
                    echo "Running on branch: $BRANCH_NAME"
                    echo "Checking if branch is allowed..."

                    # Check if branch is in allowed list
                    BRANCH_ALLOWED=false
                    for allowed_branch in $ALLOWED_BRANCHES; do
                      # Remove any surrounding quotes
                      allowed_branch=$(echo "$allowed_branch" | sed 's/^"//;s/"$//')

                      # Support glob patterns
                      if [[ "$BRANCH_NAME" == $allowed_branch ]]; then
                        BRANCH_ALLOWED=true
                        echo "✓ Branch '$BRANCH_NAME' matches pattern '$allowed_branch'"
                        break
                      fi
                    done

                    if [ "$BRANCH_ALLOWED" = true ]; then
                      echo "is_valid=true" >> $GITHUB_OUTPUT
                      echo "tag_version=" >> $GITHUB_OUTPUT
                    else
                      echo "✗ Branch '$BRANCH_NAME' is not in allowed branches list"
                      echo "Allowed patterns: $(echo "$ALLOWED_BRANCHES" | tr '\n' ', ' | sed 's/,$//')"
                      echo "is_valid=false" >> $GITHUB_OUTPUT
                      echo "tag_version=" >> $GITHUB_OUTPUT
                    fi
                  fi

    semantic-release:
        name: semantic-release
        needs: validate-tag-for-workflow-dispatch
        if: always() && (github.event_name != 'workflow_dispatch' || (github.event_name == 'workflow_dispatch' && needs.validate-tag-for-workflow-dispatch.outputs.is_valid == 'true'))
        runs-on: ubuntu-latest
        outputs:
            new_release_version: ${{ steps.determine-version.outputs.version }}
            new_release_published: ${{ steps.determine-version.outputs.published }}
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 0

            - id: release
              name: Release
              uses: cycjimmy/semantic-release-action@b12c8f6015dc215fe37bc154d4ad456dd3833c90 # v6.0.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Determine version from release or tag
              id: determine-version
              run: |
                  # Set the published status
                  PUBLISHED="${{ steps.release.outputs.new_release_published }}"
                  echo "published=$PUBLISHED" >> $GITHUB_OUTPUT

                  # Check if new release was published
                  if [ "$PUBLISHED" == "false" ]; then
                      # Get the current commit SHA
                      CURRENT_SHA=$(git rev-parse HEAD)
                      # Find the tag that points to this commit and starts with 'v'
                      EXISTING_TAG=$(git tag --points-at $CURRENT_SHA | grep '^v' | head -1)
                      if [ -n "$EXISTING_TAG" ]; then
                          # Use the existing tag version (remove 'v' prefix)
                          VERSION=${EXISTING_TAG#v}
                          echo "version=$VERSION" >> $GITHUB_OUTPUT
                          echo "Using existing tag: $EXISTING_TAG"
                      else
                          # No tag found, this is an error case
                          echo "::error::No existing tag found on commit and no new release published"
                          echo "::error::This commit must have a tag starting with 'v'"
                          exit 1
                      fi
                  else
                      # Use the new release version
                      echo "version=${{ steps.release.outputs.new_release_version }}" >> $GITHUB_OUTPUT
                      echo "New release: ${{ steps.release.outputs.new_release_version }}"
                  fi

            - name: Display outputs
              run: |
                  echo "Version: ${{ steps.determine-version.outputs.version }}"
                  echo "Published: ${{ steps.determine-version.outputs.published }}"
