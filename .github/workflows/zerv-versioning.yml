name: zerv-versioning

on:
    workflow_call:
        inputs:
            overridden_tag_version:
                type: string
            schema:
                type: string
                description: "Zerv flow schema"
            branch_rules:
                type: string
                default: |
                    [
                        (
                            pattern: "develop",
                            pre_release_label: beta,
                            pre_release_num: Some(1),
                            post_mode: commit
                        ),
                        (
                            pattern: "release/*",
                            pre_release_label: rc,
                            pre_release_num: None,
                            post_mode: tag
                        )
                    ]
            output_formats:
                type: string
                description: "JSON object mapping output names to zerv output formats"
                default: '{"semver": "semver", "pep440": "pep440"}'
            output_templates:
                type: string
                description: "JSON object mapping output names to zerv output templates (without quotes)"
                default: '{"docker_tag": "{{ semver_obj.docker }}"}'
            custom_outputs:
                type: string
                description: "JSON object mapping output names to full zerv command arguments"
                default: '{"v_semver": "--output-prefix v --output-format semver"}'

        outputs:
            versions:
                description: "JSON object containing all generated versions"
                value: ${{ jobs.zerv-versioning.outputs.versions }}

jobs:
    zerv-versioning:
        name: zerv-versioning
        runs-on: ubuntu-latest
        outputs:
            versions: ${{ steps.generate-versions.outputs.versions }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
              with:
                  toolchain: stable

            - name: Restore cache
              uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                  key: cargo-zerv-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      cargo-zerv-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
                      cargo-zerv-${{ runner.os }}-

            - name: Install zerv
              run: cargo install zerv || true

            - name: Generate Zerv RON
              id: zerv-ron
              # Support github.event_name == 'pull_request' or 'push'
              run: |
                  BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
                  COMMIT_HASH="${{ github.event.pull_request.head.sha || github.sha }}"

                  git checkout $COMMIT_HASH

                  if [ -n "${{ inputs.overridden_tag_version }}" ]; then
                      OVERRIDDEN_TAG_VERSION_FLAG="--tag-version ${{ inputs.overridden_tag_version }}"
                  fi

                  if [ -n "${{ inputs.schema }}" ]; then
                      SCHEMA_FLAG="--schema ${{ inputs.schema }}"
                  fi

                  # Prepare branch rules for shell (remove newlines and extra spaces)
                  BRANCH_RULES=$(echo '${{ inputs.branch_rules }}' | tr -d '\n' | tr -s ' ')

                  ZERV_RON=$(zerv flow \
                      --bumped-branch "$BRANCH_NAME" \
                      --bumped-commit-hash "g$COMMIT_HASH" \
                      $OVERRIDDEN_TAG_VERSION_FLAG \
                      $SCHEMA_FLAG \
                      --branch-rules "$BRANCH_RULES" \
                      --output-format zerv)

                  echo "zerv_ron<<EOF" >> $GITHUB_OUTPUT
                  echo "$ZERV_RON" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Convert inputs to final dictionary
              id: convert-inputs
              run: |
                  # Parse JSON inputs
                  OUTPUT_FORMATS='${{ inputs.output_formats }}'
                  OUTPUT_TEMPLATES='${{ inputs.output_templates }}'
                  CUSTOM_OUTPUTS='${{ inputs.custom_outputs }}'

                  # Validate JSON inputs and check for duplicate keys
                  echo "$OUTPUT_FORMATS" | jq . > /dev/null || { echo "Invalid JSON in output_formats"; exit 1; }
                  echo "$OUTPUT_TEMPLATES" | jq . > /dev/null || { echo "Invalid JSON in output_templates"; exit 1; }
                  echo "$CUSTOM_OUTPUTS" | jq . > /dev/null || { echo "Invalid JSON in custom_outputs"; exit 1; }

                  # Extract all keys from each input
                  FORMAT_KEYS=$(echo "$OUTPUT_FORMATS" | jq -r 'keys[]')
                  TEMPLATE_KEYS=$(echo "$OUTPUT_TEMPLATES" | jq -r 'keys[]')
                  CUSTOM_KEYS=$(echo "$CUSTOM_OUTPUTS" | jq -r 'keys[]')

                  # Check for duplicate keys across inputs
                  ALL_KEYS=$(echo -e "$FORMAT_KEYS\n$TEMPLATE_KEYS\n$CUSTOM_KEYS" | sort | uniq -d)
                  if [ -n "$ALL_KEYS" ]; then
                      echo "Error: Duplicate keys found in inputs: $ALL_KEYS"
                      echo "Keys must be unique across output_formats, output_templates, and custom_outputs"
                      exit 1
                  fi

                  # Combine all inputs into a single JSON object with their arguments
                  ALL_OUTPUTS=$(jq -n \
                    --argjson formats "$OUTPUT_FORMATS" \
                    --argjson templates "$OUTPUT_TEMPLATES" \
                    --argjson custom "$CUSTOM_OUTPUTS" \
                    '[
                      ($formats | to_entries | map({key: .key, value: ("--output-format " + .value)})),
                      ($templates | to_entries | map({key: .key, value: ("--output-template \"" + .value + "\"")})),
                      ($custom | to_entries | map({key: .key, value: .value}))
                    ] |
                    flatten |
                    map({(.key): .value}) |
                    reduce .[] as $item ({}; . + $item)')

                  # Debug: print the result
                  echo "Generated version_outputs:"
                  echo "$ALL_OUTPUTS"

                  # Output the combined dictionary using multiline format
                  {
                      echo "version_outputs<<EOF"
                      echo "$ALL_OUTPUTS"
                      echo "EOF"
                  } >> $GITHUB_OUTPUT

            - name: Generate versions
              id: generate-versions
              run: |
                  # Get ZERV_RON from previous step
                  ZERV_RON='${{ steps.zerv-ron.outputs.zerv_ron }}'

                  # Get version outputs from conversion step
                  VERSION_OUTPUTS='${{ steps.convert-inputs.outputs.version_outputs }}'

                  # Create JSON object to store versions
                  VERSIONS_JSON="{}"

                  # Process all outputs and build the JSON
                  while IFS= read -r entry; do
                      _jq() {
                          echo ${entry} | base64 --decode | jq -r ${1}
                      }
                      key=$(_jq '.key')
                      args=$(_jq '.value')
                      value=$(echo "$ZERV_RON" | eval zerv version --source stdin $args)
                      VERSIONS_JSON=$(echo "$VERSIONS_JSON" | jq --arg key "$key" --arg value "$value" '. + {($key): $value}')
                  done < <(echo "$VERSION_OUTPUTS" | jq -r 'to_entries[] | @base64')

                  # Compact the JSON and output using heredoc format
                  VERSIONS_JSON_COMPACT=$(echo "$VERSIONS_JSON" | jq -c .)
                  {
                      echo "versions<<EOF"
                      echo "$VERSIONS_JSON_COMPACT"
                      echo "EOF"
                  } >> $GITHUB_OUTPUT

            - name: Display generated versions
              run: |
                  echo '${{ steps.generate-versions.outputs.versions }}' | jq .

            - name: Save cache
              uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
              if: always()
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                  key: cargo-zerv-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
