name: zerv-versioning

on:
    workflow_call:
        outputs:
            version:
                description: "Generated version"
                value: ${{ jobs.zerv-versioning.outputs.version }}

jobs:
    zerv-versioning:
        name: zerv-versioning
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.get-version.outputs.version }}
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
              with:
                  toolchain: stable

            - name: Restore cache
              uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                  key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-${{ github.run_id }}-zerv
                  restore-keys: |
                      cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
                      cargo-${{ runner.os }}-

            - name: Install zerv
              run: cargo install zerv || true

            - name: Debugging
              id: debugging
              run: |
                  which zerv
                  echo $(zerv version --output-template "{{ dirty }}")
                  echo $(zerv version --output-template "{{ distance }}")
                  echo $(zerv version --output-template "{{ bumped_branch }}")
                  echo $(zerv version --output-template "{{ hash_int(value=bumped_branch, length=5) }}")
                  echo $(zerv version --bumped-branch test --output-template "{{ hash_int(value=bumped_branch, length=5) }}")

                  # Always get the correct branch name (works for both PR and push)
                  if [ -n "${{ github.head_ref }}" ]; then
                      # This is a PR, use the source branch
                      current_branch="${{ github.head_ref }}"
                  else
                      # This is a regular push, use the ref_name
                      current_branch="${{ github.ref_name }}"
                  fi
                  echo "Current branch: $current_branch"

                  # Alternative using bash conditional
                  current_branch_alt="${{ github.head_ref || github.ref_name }}"
                  echo "Current branch (alternative): $current_branch_alt"

            - name: Generate version
              id: get-version
              run: |
                  VERSION=$(zerv flow)
                  echo "Generated version: $VERSION"
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Save cache
              uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
              if: always()
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                  key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-${{ github.run_id }}-zerv
