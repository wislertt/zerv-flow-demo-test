name: ci

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    main-sync-validation:
        name: Check PR is up-to-date with main
        runs-on: ubuntu-latest
        if: github.base_ref == 'main'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check if PR branch is behind main
              run: |
                  echo "Checking if PR branch is behind main..."
                  git fetch origin main
                  BEHIND=$(git rev-list --count HEAD..origin/main)
                  if [ "$BEHIND" -gt 0 ]; then
                    echo "::error::PR branch is $BEHIND commits behind main. Please update your branch."
                    echo "::error::Run 'git fetch origin' and 'git rebase origin/main' to update."
                    exit 1
                  else
                    echo "PR branch is up-to-date with main."
                  fi

    zerv-versioning:
        name: zerv-versioning
        uses: ./.github/workflows/zerv-versioning.yml
        needs: main-sync-validation

    # test:
    #     uses: ./.github/workflows/test.yml
    #     secrets:
    #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    # pre-commit:
    #     uses: ./.github/workflows/pre-commit.yml

    deploy:
        needs: zerv-versioning
        uses: ./.github/workflows/deploy.yml
        with:
            semver: ${{ needs.zerv-versioning.outputs.semver }}
            pep440: ${{ needs.zerv-versioning.outputs.pep440 }}
            docker_tag: ${{ needs.zerv-versioning.outputs.docker_tag }}
            env: "d" # development
