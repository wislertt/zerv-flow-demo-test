name: cd

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write
    issues: write
    pull-requests: write

jobs:
    # ====================================================
    # Tag Validation for workflow_dispatch
    # ====================================================
    validate-tag:
        name: Validate tag for workflow_dispatch
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch'
        outputs:
            is_valid: ${{ steps.check-tag.outputs.is_valid }}
            tag_version: ${{ steps.check-tag.outputs.tag_version }}
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 0

            - name: Check tag format
              id: check-tag
              run: |
                  # Get the current ref
                  REF="${{ github.ref }}"

                  # Check if ref is a tag
                  if [[ $REF == refs/tags/* ]]; then
                      # Extract tag name from ref
                      TAG_NAME=${REF#refs/tags/}
                      echo "Checking tag: $TAG_NAME"

                      # Validate tag format: vX.X.X where X is numeric
                      if [[ $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                          echo "✓ Tag format is valid"
                          echo "is_valid=true" >> $GITHUB_OUTPUT
                          # Remove 'v' prefix for version
                          VERSION=${TAG_NAME#v}
                          echo "tag_version=$VERSION" >> $GITHUB_OUTPUT
                      else
                          echo "✗ Invalid tag format. Expected format: vX.X.X (e.g., v1.0.0)"
                          echo "Found: $TAG_NAME"
                          echo "is_valid=false" >> $GITHUB_OUTPUT
                          echo "tag_version=" >> $GITHUB_OUTPUT
                      fi
                  else
                      echo "Not a tag, running on branch: $REF"
                      echo "is_valid=true" >> $GITHUB_OUTPUT
                      echo "tag_version=" >> $GITHUB_OUTPUT
                  fi

    # ====================================================
    # Versioning and Release
    # ====================================================
    semantic-release:
        name: semantic-release
        needs: validate-tag
        if: github.event_name != 'workflow_dispatch' || needs.validate-tag.outputs.is_valid == 'true'
        runs-on: ubuntu-latest
        outputs:
            new_release_version: ${{ steps.determine-version.outputs.version }}
            new_release_published: ${{ steps.determine-version.outputs.published }}
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 0

            - id: release
              name: Release
              uses: cycjimmy/semantic-release-action@b12c8f6015dc215fe37bc154d4ad456dd3833c90 # v6.0.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Determine version from release or tag
              id: determine-version
              run: |
                  # Set the published status
                  PUBLISHED="${{ steps.release.outputs.new_release_published }}"
                  echo "published=$PUBLISHED" >> $GITHUB_OUTPUT

                  # Check if we have a validated tag from workflow_dispatch
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ needs.validate-tag.outputs.tag_version }}" ]; then
                      # Use the validated tag version
                      VERSION="${{ needs.validate-tag.outputs.tag_version }}"
                      echo "version=$VERSION" >> $GITHUB_OUTPUT
                      echo "Using validated workflow_dispatch tag: v$VERSION"
                  elif [ "$PUBLISHED" == "false" ]; then
                      # Get the current commit SHA
                      CURRENT_SHA=$(git rev-parse HEAD)
                      # Find the tag that points to this commit and starts with 'v'
                      EXISTING_TAG=$(git tag --points-at $CURRENT_SHA | grep '^v' | head -1)
                      if [ -n "$EXISTING_TAG" ]; then
                          # Use the existing tag version (remove 'v' prefix)
                          VERSION=${EXISTING_TAG#v}
                          echo "version=$VERSION" >> $GITHUB_OUTPUT
                          echo "Using existing tag: $EXISTING_TAG"
                      else
                          # No tag found, this is an error case
                          echo "::error::No existing tag found on commit and no new release published"
                          echo "::error::This commit must have a tag starting with 'v'"
                          exit 1
                      fi
                  else
                      # Use the new release version
                      echo "version=${{ steps.release.outputs.new_release_version }}" >> $GITHUB_OUTPUT
                      echo "New release: ${{ steps.release.outputs.new_release_version }}"
                  fi

            - name: Display outputs
              run: |
                  echo "Version: ${{ steps.determine-version.outputs.version }}"
                  echo "Published: ${{ steps.determine-version.outputs.published }}"

    zerv-versioning:
        needs: [validate-tag, semantic-release]
        uses: ./.github/workflows/zerv-versioning.yml

    # ====================================================
    # Test and Lint
    # ====================================================
    # test:
    #     uses: ./.github/workflows/test.yml
    #     secrets:
    #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    # ====================================================
    # Deployment with environment
    # ====================================================
    deploy-all-env:
        needs: zerv-versioning
        uses: ./.github/workflows/deploy-all-env.yml
        with:
            semver: ${{ needs.zerv-versioning.outputs.semver }}
            pep440: ${{ needs.zerv-versioning.outputs.pep440 }}
            docker_tag: ${{ needs.zerv-versioning.outputs.docker_tag }}
            deploy_labels: '{"deploy-d": true, "deploy-n": true, "deploy-p": true}'

    # ====================================================
    # Deployment without environment
    # ====================================================
    deploy-no-env:
        needs: zerv-versioning
        uses: ./.github/workflows/deploy-no-env.yml
        with:
            semver: ${{ needs.zerv-versioning.outputs.semver }}
            pep440: ${{ needs.zerv-versioning.outputs.pep440 }}
            docker_tag: ${{ needs.zerv-versioning.outputs.docker_tag }}
